{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'join_this_ride_modal.html' %}
<div class="container py-4">
    <div class="card shadow">
        <!-- Card Header with Driver Info -->
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Ride Details</h3>
            <div class="d-flex align-items-center">

                {% if driver.path_to_profile_picture %}
                <img src="{% static 'base/profile_pictures/'|add:driver.path_to_profile_picture|default:'base/profile_pictures/default_avatar.png' %}" 
                class="rounded-circle me-2" 
                width="40" 
                height="40" 
                alt="Driver photo">

                {% else %}
                <img src="{% static 'base/profile_pictures/default_picture.png' %}" 
                class="rounded-circle me-2" 
                width="40" 
                height="40" 
                alt="Driver photo">



                {% endif %}
                <span>Posted by {{ driver.username }}</span>
            </div>
        </div>

        <!-- Card Body -->
        <div class="card-body">
            <!-- Route Information -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="text-muted">From</label>
                        <h5>{{ ride.start }}</h5>
                    </div>
                    <div>
                        <label class="text-muted">To</label>
                        <h5>{{ ride.end }}</h5>
                    </div>
                </div>
                
                <!-- Ride Stats -->
                <div class="col-md-6">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <i class="bi bi-calendar me-2"></i>
                                <small class="text-muted">Date</small>
                                <div>{{ ride.start_date|date:"M d, Y" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <i class="bi bi-clock me-2"></i>
                                <small class="text-muted">Time</small>
                                <div>{{ ride.start_date|time:"H:i" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <i class="bi bi-map me-2"></i>
                                <small class="text-muted">Distance</small>
                                <div>{{ ride.distance_km|floatformat:1 }} km</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded">
                                <i class="bi bi-people me-2"></i>
                                <small class="text-muted">Available Seats</small>
                                <div>{{ ride.travelers }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Application Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-primary me-2">
                                            <i class="bi bi-people-fill"></i>
                                            {{ ride.applicant_count }}
                                        </div>
                                        <span>Total Applicants</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-warning me-2">
                                            <i class="bi bi-clock"></i>
                                            {{ ride.pending_count }}
                                        </div>
                                        <span>Pending</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-success me-2">
                                            <i class="bi bi-check-circle"></i>
                                            {{ ride.approved_count }}
                                        </div>
                                        <span>Approved</span>
                                    </div>
                                </div>
                            </div>
            <!-- Map -->
            <div class="mb-4">
                <div id="map" style="height: 300px;" class="rounded"></div>
            </div>

            <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
            <a href="{% url 'rides' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Rides
            </a>
            
            <a href="https://wa.me/{{ driver.phone_number_user }}?text=Hi%20there!%20I%20would%20like%20to%20know%20more%20about%20your%20services." 
                target="_blank" 
                class="btn btn-outline-success">
                    <i class="bi bi-whatsapp"></i> Contact on WhatsApp
                </a>

            <form method="post" class="d-inline">
                {% csrf_token %}
                {% if user.is_authenticated %}
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#joinRideConfirmModal">
                    <i class="bi bi-check-lg"></i> Join This Ride
                </button>
            {% else %}
                <a href="{% url 'login:login' %}?next={{ request.path }}" class="btn btn-primary">
                    <i class="bi bi-box-arrow-in-right"></i> Login to Join Ride
                </a>
            {% endif %}
            </form>
        </div>
        </div>
    </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!-- Map Script -->
<script>
function initMap() {
    const mapElement = document.getElementById('map');
    if (!mapElement) return;

    const map = new google.maps.Map(mapElement, {
        mapTypeId: 'terrain',
        zoom: 12
    });

    const origin = new google.maps.LatLng(
        {{ ride.origin_latitude }},
        {{ ride.origin_longitude }}
    );
    const destination = new google.maps.LatLng(
        {{ ride.destination_latitude }},
        {{ ride.destination_longitude }}
    );

    const bounds = new google.maps.LatLngBounds();
    bounds.extend(origin);
    bounds.extend(destination);
    map.fitBounds(bounds);

    const decodedPath = google.maps.geometry.encoding.decodePath(
        '{{ ride.selected_route_polyline|escapejs }}'
    );
    
    new google.maps.Polyline({
        path: decodedPath,
        map: map,
        geodesic: true,
        strokeColor: '#007bff',
        strokeOpacity: 1.0,
        strokeWeight: 3
    });

    new google.maps.Marker({
        position: origin,
        map: map,
        title: 'Start',
        label: 'A'
    });

    new google.maps.Marker({
        position: destination,
        map: map,
        title: 'End',
        label: 'B'
    });
}

document.getElementById('confirmJoinRide').addEventListener('click', function() {
    // Get the form that wraps the join button
    const form = document.querySelector('form');
    // Submit the form
    form.submit();
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('joinRideConfirmModal'));
    modal.hide();
});
</script>



<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYNmHSbg3hBxI5CFQUWPlJsMPjzcvtzII&libraries=geometry&callback=initMap" async defer></script>
{% endblock %}